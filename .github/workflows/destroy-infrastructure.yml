name: üí• Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'

permissions:
  contents: read

jobs:
  destroy:
    name: üí• Destroy All Resources
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "‚ùå You must type DESTROY exactly to confirm"
            exit 1
          fi
          echo "‚úÖ Destruction confirmed"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Detect Terraform Directory
        id: detect
        run: |
          if [ -f "main.tf" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          elif [ -f "terraform/main.tf" ]; then
            echo "dir=terraform" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
          fi

      - name: Scan for Resources to Destroy
        id: scan
        run: |
          TF_DIR="${{ steps.detect.outputs.dir }}"
          echo "üìÅ Detected Terraform directory: $TF_DIR"
          if [ ! -f "$TF_DIR/terraform.tfvars" ]; then
            echo "‚ùå ERROR: File not found: $TF_DIR/terraform.tfvars"
            exit 1
          fi
          PROJECT_NAME=$(grep -E '^project_name\s*=' "$TF_DIR/terraform.tfvars" | cut -d '"' -f2)
          if [ -z "$PROJECT_NAME" ]; then
            echo "‚ùå ERROR: Could not extract project_name from $TF_DIR/terraform.tfvars"
            exit 1
          fi
          echo "‚úÖ PROJECT_NAME: $PROJECT_NAME"
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          PREFIX="${PROJECT_NAME}-${{ github.event.inputs.environment }}"
          
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
          
          echo "## üí• Scanning for Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Prefix:** $PREFIX" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Type | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # IMPROVED CloudFront detection - uses PROJECT_NAME for comment matching
          CF_DISTRIBUTIONS=$(aws cloudfront list-distributions --output json 2>/dev/null | jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PROJECT_NAME\")) | .Id" 2>/dev/null || true)
          CF_COUNT=$(echo "$CF_DISTRIBUTIONS" | grep -v '^$' | wc -l)
          echo "| CloudFront Distributions | $CF_COUNT | Will be disabled then deleted |" >> $GITHUB_STEP_SUMMARY
    
          # Also check by origin domain as backup
          CF_ORIGIN_COUNT=$(aws cloudfront list-distributions --output json 2>/dev/null | jq -r ".DistributionList.Items[]? | .Origins.Items[]? | select(.DomainName != null) | select(.DomainName | contains(\"$PREFIX\")) | .Id" | sort -u | wc -l)
          if [ $CF_ORIGIN_COUNT -gt 0 ]; then
            echo "| CloudFront (by origin) | $CF_ORIGIN_COUNT | Additional detection method |" >> $GITHUB_STEP_SUMMARY
          fi
          
          WAF_COUNT=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX-waf\")) | .Name" | wc -l)
          echo "| WAF Web ACLs | $WAF_COUNT | Will be deleted |" >> $GITHUB_STEP_SUMMARY
          
          S3_COUNT=$(aws s3api list-buckets --output json 2>/dev/null | jq -r ".Buckets[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          echo "| S3 Buckets | $S3_COUNT | Will be emptied and deleted |" >> $GITHUB_STEP_SUMMARY
          
          OAC_COUNT=$(aws cloudfront list-origin-access-controls --output json 2>/dev/null | jq -r ".OriginAccessControlList.Items[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          echo "| Origin Access Controls | $OAC_COUNT | Will be deleted |" >> $GITHUB_STEP_SUMMARY
          
          RHP_COUNT=$(aws cloudfront list-response-headers-policies --type custom --output json 2>/dev/null | jq -r ".ResponseHeadersPolicyList.Items[]? | select(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name | contains(\"$PREFIX\")) | .ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name" | wc -l)
          echo "| Response Headers Policies | $RHP_COUNT | Will be deleted |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "Step 1: Disable and Delete CloudFront Distributions"
        continue-on-error: true
        run: |
              PROJECT_NAME="${{ steps.scan.outputs.project_name }}"
              PREFIX="${{ steps.scan.outputs.prefix }}"
              
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "‚òÅÔ∏è  STEP 1: Disable and Delete CloudFront Distributions"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
              echo "üîç Using PROJECT_NAME: $PROJECT_NAME"
              echo "üîç Using PREFIX: $PREFIX"
              echo ""
              
              ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
              echo "üîê AWS Account ID: $ACCOUNT_ID"
              echo ""

              TOTAL_FOUND=0
              TOTAL_DISABLED=0
              TOTAL_DELETED=0
              TOTAL_FAILED=0
              FAILED_DISTRIBUTIONS=()

              echo "üìä Starting CloudFront cleanup process..."
              echo "‚è∞ Start time: $(date)"
              echo ""

              # Grab all distributions and their key fields
              DISTRIBUTIONS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
                jq -r '.DistributionList.Items[]? | "\(.Id)|\(.Comment // "")|\(.Status)|\(.Enabled)|\(.WebACLId // "null")"' || true)

              if [ -z "$DISTRIBUTIONS" ]; then
                echo "‚úÖ No CloudFront distributions found to process"
              else
                TOTAL_FOUND=$(echo "$DISTRIBUTIONS" | wc -l)
                echo "üìç Found $TOTAL_FOUND distributions to process:"
                echo ""

                echo "$DISTRIBUTIONS" | while IFS='|' read -r dist_id comment status enabled webacl_id; do
                  if [[ "$comment" == *"$PROJECT_NAME"* || "$dist_id" == *"$PREFIX"* ]]; then
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "üîÑ Processing: $dist_id"
                    echo "   Comment: $comment"
                    echo "   Status: $status"
                    echo "   Enabled: $enabled"
                    echo "   WAF Attached: $webacl_id"
                    echo ""

                    # Get current config
                    CONFIG_FILE="/tmp/cf_${dist_id}_config.json"
                    DISABLED_FILE="/tmp/cf_${dist_id}_disabled.json"
                    ERROR_FILE="/tmp/cf_${dist_id}_error.log"

                    if ! aws cloudfront get-distribution-config --id "$dist_id" > "$CONFIG_FILE" 2>"$ERROR_FILE"; then
                      echo "      ‚ùå Failed to fetch distribution config for $dist_id"
                      echo "      üîç CLI error:"
                      sed -n '1,20p' "$ERROR_FILE" || true
                      FAILED_DISTRIBUTIONS+=("$dist_id:config_fetch_failed")
                      TOTAL_FAILED=$((TOTAL_FAILED + 1))
                      rm -f "$CONFIG_FILE" "$ERROR_FILE"
                      continue
                    fi

                    ETAG=$(jq -r '.ETag' "$CONFIG_FILE")
                    if [ -z "$ETAG" ] || [ "$ETAG" = "null" ]; then
                      echo "      ‚ùå Could not read ETag for $dist_id"
                      FAILED_DISTRIBUTIONS+=("$dist_id:etag_missing")
                      TOTAL_FAILED=$((TOTAL_FAILED + 1))
                      rm -f "$CONFIG_FILE"
                      continue
                    fi
                    echo "      ‚úÖ Config fetched (ETag: $ETAG)"

                    # Step A: Disassociate WAF (use wafv2)
                    if [ "$webacl_id" != "null" ] && [ -n "$webacl_id" ]; then
                      echo "      üõ°Ô∏è  Disassociating WAF using wafv2..."
                      if aws wafv2 disassociate-web-acl --resource-arn "arn:aws:cloudfront::${ACCOUNT_ID}:distribution/$dist_id" --region us-east-1 2>>"$ERROR_FILE"; then
                        echo "      ‚úÖ wafv2 disassociate attempted"
                      else
                        echo "      ‚ö†Ô∏è  wafv2 disassociate returned error (continuing). See log:"
                        sed -n '1,20p' "$ERROR_FILE" || true
                      fi
                    fi

                    # Step B: Prepare disabled distribution config
                    # - Set Enabled = false
                    # - Remove/disable Logging to avoid "S3 bucket doesn't exist" errors
                    # - Preserve TrustedSigners / TrustedKeyGroups with safe defaults
                    jq '
                      .DistributionConfig
                      | .Enabled = false
                      | .WebACLId = ""
                      | (.DefaultCacheBehavior.TrustedSigners) = (.DefaultCacheBehavior.TrustedSigners // {Enabled:false, Quantity:0})
                      | (.DefaultCacheBehavior.TrustedKeyGroups) = (.DefaultCacheBehavior.TrustedKeyGroups // {Enabled:false, Quantity:0})
                      | (.Logging) = (.Logging // {})
                      | (.Logging.Enabled) = false
                      # remove bucket/prefix/includeCookies fields that can cause InvalidArgument if bucket missing
                      | ( .Logging |= (del(.Bucket, .IncludeCookies, .Prefix) ) )
                    ' "$CONFIG_FILE" > "$DISABLED_FILE"

                    echo "      üîß Disabled config prepared (logging removed/sanitized)."

                    # Step C: Apply update-distribution to disable
                    echo "      üöÄ Applying updated configuration to disable distribution..."
                    if aws cloudfront update-distribution --id "$dist_id" --if-match "$ETAG" --distribution-config file://"$DISABLED_FILE" 2>"$ERROR_FILE"; then
                      echo "      ‚úÖ Update-distribution accepted"
                    else
                      echo "      ‚ùå Update-distribution failed. AWS CLI error:"
                      sed -n '1,50p' "$ERROR_FILE" || true
                      # continue ‚Äî try again later; mark as failure for now
                      FAILED_DISTRIBUTIONS+=("$dist_id:update_failed")
                      TOTAL_FAILED=$((TOTAL_FAILED + 1))
                      rm -f "$CONFIG_FILE" "$DISABLED_FILE" "$ERROR_FILE"
                      continue
                    fi

                    # Step D: Poll until distribution is disabled (or timeout)
                    echo "      ‚è≥ Polling for distribution to become Disabled (timeout 12 minutes)..."
                    MAX_RETRIES=24   # 24 * 30s = 12 minutes
                    SLEEP_SECONDS=30
                    retry=0
                    while [ $retry -lt $MAX_RETRIES ]; do
                      sleep $SLEEP_SECONDS
                      CURRENT_ENABLED=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.DistributionConfig.Enabled' --output text 2>/dev/null || echo "Unknown")
                      CURRENT_STATUS=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.Status' --output text 2>/dev/null || echo "Unknown")
                      echo "         Poll #$((retry+1)): Enabled=$CURRENT_ENABLED Status=$CURRENT_STATUS"
                      if [ "$CURRENT_ENABLED" = "false" ] || [ "$CURRENT_ENABLED" = "False" ]; then
                        echo "      ‚úÖ Distribution reports Enabled=false"
                        TOTAL_DISABLED=$((TOTAL_DISABLED + 1))
                        break
                      fi
                      retry=$((retry+1))
                    done

                    if [ $retry -ge $MAX_RETRIES ]; then
                      echo "      ‚ö†Ô∏è  Timeout waiting for distribution to be disabled"
                      FAILED_DISTRIBUTIONS+=("$dist_id:disable_timeout")
                      TOTAL_FAILED=$((TOTAL_FAILED + 1))
                      rm -f "$CONFIG_FILE" "$DISABLED_FILE" "$ERROR_FILE"
                      continue
                    fi

                    # Step E: Re-fetch ETag (it may have changed) and attempt deletion
                    DELETE_ETAG=$(aws cloudfront get-distribution --id "$dist_id" --query 'ETag' --output text)
                    if [ -z "$DELETE_ETAG" ] || [ "$DELETE_ETAG" = "None" ]; then
                      echo "      ‚ùå Could not re-fetch ETag for deletion"
                      FAILED_DISTRIBUTIONS+=("$dist_id:delete_etag_failed")
                      TOTAL_FAILED=$((TOTAL_FAILED + 1))
                      rm -f "$CONFIG_FILE" "$DISABLED_FILE" "$ERROR_FILE"
                      continue
                    fi
                    echo "      ‚úÖ ETag for deletion: $DELETE_ETAG"
                    echo "      üöÄ Attempting delete-distribution..."
                    DELETE_ERROR_FILE="/tmp/aws_delete_error_${dist_id}.log"
                    if aws cloudfront delete-distribution --id "$dist_id" --if-match "$DELETE_ETAG" 2>"$DELETE_ERROR_FILE"; then
                      echo "      ‚úÖ delete-distribution command accepted"
                      TOTAL_DELETED=$((TOTAL_DELETED + 1))
                    else
                      echo "      ‚ö†Ô∏è  delete-distribution failed (check why):"
                      sed -n '1,40p' "$DELETE_ERROR_FILE" || true
                      # Check current state
                      CUR_STATUS=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.Status' --output text 2>/dev/null || echo "Unknown")
                      CUR_ENABLED=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.DistributionConfig.Enabled' --output text 2>/dev/null || echo "Unknown")
                      echo "      üîç Current state - Status: $CUR_STATUS, Enabled: $CUR_ENABLED"
                      # If still enabled then it will be retried later (don't mark as permanent fail here)
                      if [ "$CUR_ENABLED" = "true" ]; then
                        FAILED_DISTRIBUTIONS+=("$dist_id:still_enabled")
                        TOTAL_FAILED=$((TOTAL_FAILED + 1))
                      else
                        # unknown reason; log and mark
                        FAILED_DISTRIBUTIONS+=("$dist_id:delete_failed")
                        TOTAL_FAILED=$((TOTAL_FAILED + 1))
                      fi
                      rm -f "$DELETE_ERROR_FILE"
                    fi

                    echo "   ‚úÖ Processing completed for $dist_id"
                    echo ""

                    # cleanup
                    rm -f "$CONFIG_FILE" "$DISABLED_FILE" "$ERROR_FILE" || true

                  else
                    echo "‚è≠Ô∏è  Skipping: $dist_id (comment doesn't match: $comment)"
                  fi
                done

                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo "üìä STEP 1 COMPLETION SUMMARY"
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo "‚è∞ End time: $(date)"
                echo ""
                echo "üìà Progress Metrics:"
                echo "   üìã Total Found:    $TOTAL_FOUND"
                echo "   üîÑ Total Disabled: $TOTAL_DISABLED"
                echo "   üóëÔ∏è  Total Deleted:  $TOTAL_DELETED"
                echo "   ‚ùå Total Failed:    $TOTAL_FAILED"
                echo ""

                if [ $TOTAL_FAILED -gt 0 ]; then
                  echo "‚ö†Ô∏è  Failed Distributions:"
                  for failed in "${FAILED_DISTRIBUTIONS[@]}"; do
                    echo "   - $failed"
                  done
                  echo ""
                  echo "üí° Failed distributions will be retried in Step 9"
                fi

                if [ $TOTAL_DELETED -eq $TOTAL_FOUND ]; then
                  echo "üéâ SUCCESS: All distributions processed successfully!"
                elif [ $TOTAL_DELETED -gt 0 ]; then
                  echo "‚úÖ PARTIAL SUCCESS: Some distributions processed, others will be retried"
                else
                  echo "‚ùå NO DISTRIBUTIONS: Could not process any distributions"
                fi
              fi

              echo ""
              echo "‚è≥ Waiting 60 seconds for operations to propagate..."
              sleep 60
              echo "‚úÖ Step 1 completed - proceeding to next steps"


      - name: "Step 2: Empty and Delete S3 Buckets"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì¶ STEP 2: Emptying and Deleting S3 Buckets"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          BUCKETS=$(aws s3api list-buckets --output json 2>/dev/null | \
            jq -r ".Buckets[]? | select(.Name | contains(\"$PREFIX\")) | .Name" 2>/dev/null || true)
          
          if [ -z "$BUCKETS" ]; then
            echo "‚ÑπÔ∏è  No S3 buckets found with prefix: $PREFIX"
          else
            echo "$BUCKETS" | while read -r bucket; do
              echo "üìç Bucket: $bucket"
              echo "   Emptying all objects and versions..."
              
              # Delete all object versions
              aws s3api list-object-versions --bucket "$bucket" --output json 2>/dev/null | \
                jq -r '.Versions[]?, .DeleteMarkers[]? | "\(.Key)\t\(.VersionId)"' | \
                while IFS=$'\t' read -r key version; do
                  if [ -n "$key" ]; then
                    aws s3api delete-object --bucket "$bucket" --key "$key" --version-id "$version" 2>/dev/null || true
                  fi
                done
              
              # Delete all objects (non-versioned)
              aws s3 rm "s3://$bucket" --recursive --quiet 2>/dev/null || true
              
              echo "   Deleting bucket..."
              aws s3 rb "s3://$bucket" --force 2>&1 | grep -v "BucketNotEmpty\|NoSuchBucket" && \
              echo "   ‚úÖ Deleted" || echo "   ‚ö†Ô∏è  Could not delete (may still have objects)"
            done
          fi

      - name: "Step 3: Delete WAF Web ACLs"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üõ°Ô∏è  STEP 3: Deleting WAF Web ACLs"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          WAFS=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | \
            jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | \"\(.Id)|\(.Name)|\(.LockToken)\"" 2>/dev/null || true)
          
          if [ -z "$WAFS" ]; then
            echo "‚ÑπÔ∏è  No WAF Web ACLs found with prefix: $PREFIX"
          else
            echo "$WAFS" | while IFS='|' read -r waf_id waf_name lock_token; do
              echo "üìç WAF: $waf_name"
              
              ATTACHED=$(aws cloudfront list-distributions --output json 2>/dev/null | \
                        jq -r ".DistributionList.Items[]? | select(.WebACLId | contains(\"$waf_id\")) | .Id" | head -1)
              
              if [ -n "$ATTACHED" ]; then
                echo "   ‚è≥ Still attached to CloudFront $ATTACHED, will retry later"
              else
                echo "   Deleting..."
                aws wafv2 delete-web-acl \
                  --name "$waf_name" \
                  --scope CLOUDFRONT \
                  --id "$waf_id" \
                  --lock-token "$lock_token" \
                  --region us-east-1 2>&1 | grep -v "error" && \
                echo "   ‚úÖ Deleted" || echo "   ‚ö†Ô∏è  Could not delete"
              fi
            done
          fi

      - name: "Wait for CloudFront Distributions"
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚è≥ WAITING: CloudFront Distributions to Fully Disable"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "This may take 10-15 minutes. Checking every 60 seconds..."
          echo ""
          
          MAX_WAIT=900
          ELAPSED=0
          FOUND_DISTRIBUTIONS=false
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            DIST_IDS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
                      jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PREFIX\")) | .Id" 2>/dev/null || true)
            
            if [ -z "$DIST_IDS" ]; then
              if [ "$FOUND_DISTRIBUTIONS" = "false" ] && [ $ELAPSED -eq 0 ]; then
                echo "‚ÑπÔ∏è  No distributions found with prefix: $PREFIX"
              else
                echo "‚úÖ All distributions have been deleted"
              fi
              break
            fi
            
            FOUND_DISTRIBUTIONS=true
            ALL_DISABLED=true
            
            for dist_id in $DIST_IDS; do
              STATUS=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.Status' --output text 2>/dev/null || echo "Unknown")
              ENABLED=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.DistributionConfig.Enabled' --output text 2>/dev/null || echo "Unknown")
              
              echo "   $dist_id: Status=$STATUS, Enabled=$ENABLED"
              
              if [ "$ENABLED" = "True" ] || [ "$STATUS" = "InProgress" ]; then
                ALL_DISABLED=false
              fi
            done
            
            if [ "$ALL_DISABLED" = "true" ]; then
              echo ""
              echo "‚úÖ All distributions are disabled and deployed"
              break
            fi
            
            sleep 60
            ELAPSED=$((ELAPSED + 60))
            echo "   Waited ${ELAPSED}s / ${MAX_WAIT}s..."
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "‚ö†Ô∏è  Maximum wait time reached. Some distributions may still be deploying."
          fi

      - name: "Step 9: Delete CloudFront Distributions"
        continue-on-error: true
        run: |
            PROJECT_NAME="${{ steps.scan.outputs.project_name }}"
            PREFIX="${{ steps.scan.outputs.prefix }}"
            
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚òÅÔ∏è  STEP 9: Deleting CloudFront Distributions"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            echo "üîç Using PROJECT_NAME: $PROJECT_NAME for detection"
            
            # Use the SAME detection logic as Step 1 and scan - by PROJECT_NAME in comment
            DISTRIBUTIONS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
              jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PROJECT_NAME\")) | \"\(.Id)|\(.Comment)|\(.Status)\"" 2>/dev/null || true)
            
            if [ -z "$DISTRIBUTIONS" ]; then
              echo "‚ùå No distributions found by comment. Trying origin domain detection..."
              # Fallback: detect by origin domain
              DISTRIBUTIONS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
                jq -r ".DistributionList.Items[]? | .Id as \$id | .Comment as \$comment | .Origins.Items[]? | select(.DomainName != null) | select(.DomainName | contains(\"$PREFIX\")) | \"\$id|\$comment|unknown\"" 2>/dev/null || true)
            fi
            
            if [ -z "$DISTRIBUTIONS" ]; then
              echo "‚ùå No CloudFront distributions found for deletion."
              echo "üí° Manual deletion may be required for: E191G2X7VOQUCR, E39ARSICL9MJ2Q, E2D8L23FW0GDEQ, E35EJ3YWAN0M0S, E2T09YD9M9AYYO"
            else
              echo "üìç Found distributions for deletion:"
              echo "$DISTRIBUTIONS" | while IFS='|' read -r dist_id comment status; do
                echo "   üî∏ $dist_id - $comment (Status: $status)"
              done
              echo ""
              
              echo "üóëÔ∏è  Deleting CloudFront distributions..."
              echo "$DISTRIBUTIONS" | while IFS='|' read -r dist_id comment status; do
                echo "üìç Deleting: $dist_id ($comment)"
                
                # Get the ETag and delete
                ETAG=$(aws cloudfront get-distribution --id "$dist_id" --query 'ETag' --output text 2>/dev/null)
                if [ -n "$ETAG" ]; then
                  # Attempt deletion
                  if aws cloudfront delete-distribution --id "$dist_id" --if-match "$ETAG" 2>/dev/null; then
                    echo "   ‚úÖ Deletion initiated successfully"
                  else
                    # Check if it's still deploying
                    CURRENT_STATUS=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.Status' --output text 2>/dev/null || echo "Unknown")
                    if [ "$CURRENT_STATUS" = "InProgress" ]; then
                      echo "   ‚è≥ Still deploying, will be deleted on next run"
                    else
                      echo "   ‚ùå Failed to delete (Status: $CURRENT_STATUS)"
                    fi
                  fi
                else
                  echo "   ‚ùå Could not get ETag for distribution"
                fi
              done
              
              echo ""
              echo "üìù Note: CloudFront deletions can take 15-20 minutes to complete."
              echo "   The distributions will disappear from the console when fully deleted."
            fi

      - name: "Verify CloudFront Deletion"
        continue-on-error: true
        run: |
            PROJECT_NAME="${{ steps.scan.outputs.project_name }}"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚úÖ VERIFY: CloudFront Deletion Status"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            
            # Check remaining distributions
            REMAINING_DISTRIBUTIONS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
              jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PROJECT_NAME\")) | \"\(.Id)|\(.Comment)|\(.Status)\"" 2>/dev/null || true)
            
            if [ -z "$REMAINING_DISTRIBUTIONS" ]; then
              echo "üéâ SUCCESS: All CloudFront distributions have been deleted!"
            else
              echo "‚ö†Ô∏è  Some distributions are still present:"
              echo "$REMAINING_DISTRIBUTIONS" | while IFS='|' read -r dist_id comment status; do
                echo "   üî∏ $dist_id - $comment (Status: $status)"
              done
              echo ""
              echo "üí° CloudFront deletions can take 15-20 minutes. Run this workflow again if needed."
            fi

      - name: "Step 10: Retry WAF Deletion"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üõ°Ô∏è  STEP 10: Retrying WAF Deletion (After CloudFront)"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          WAFS=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | \
            jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | \"\(.Id)|\(.Name)|\(.LockToken)\"" 2>/dev/null || true)
          
          if [ -z "$WAFS" ]; then
            echo "‚ÑπÔ∏è  No WAF Web ACLs found with prefix: $PREFIX"
          else
            echo "$WAFS" | while IFS='|' read -r waf_id waf_name lock_token; do
              echo "üìç WAF: $waf_name"
              aws wafv2 delete-web-acl \
                --name "$waf_name" \
                --scope CLOUDFRONT \
                --id "$waf_id" \
                --lock-token "$lock_token" \
                --region us-east-1 2>&1 | grep -v "error" && \
              echo "   ‚úÖ Deleted" || echo "   ‚ö†Ô∏è  Could not delete"
            done
          fi

      - name: "Step 11: Retry Response Headers Policies and OAC"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîÑ STEP 11: Retrying Policies and OAC Deletion"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # Retry Response Headers Policies
          echo "üìã Response Headers Policies:"
          RHP=$(aws cloudfront list-response-headers-policies --type custom --output json 2>/dev/null | \
            jq -r ".ResponseHeadersPolicyList.Items[]? | select(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name | contains(\"$PREFIX\")) | \"\(.ResponseHeadersPolicy.Id)|\(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name)\"" 2>/dev/null || true)
          
          if [ -n "$RHP" ]; then
            echo "$RHP" | while IFS='|' read -r policy_id policy_name; do
              echo "üìç Policy: $policy_name"
              ETAG=$(aws cloudfront get-response-headers-policy --id "$policy_id" --query 'ETag' --output text 2>/dev/null)
              aws cloudfront delete-response-headers-policy --id "$policy_id" --if-match "$ETAG" 2>&1 | grep -v "error" && \
              echo "   ‚úÖ Deleted" || echo "   ‚ö†Ô∏è  Still in use or could not delete"
            done
          else
            echo "‚ÑπÔ∏è  No Response Headers Policies found"
          fi
          
          echo ""
          
          # Retry Origin Access Controls
          echo "üîí Origin Access Controls:"
          OAC=$(aws cloudfront list-origin-access-controls --output json 2>/dev/null | \
            jq -r ".OriginAccessControlList.Items[]? | select(.Name | contains(\"$PREFIX\")) | \"\(.Id)|\(.Name)\"" 2>/dev/null || true)
          
          if [ -n "$OAC" ]; then
            echo "$OAC" | while IFS='|' read -r oac_id oac_name; do
              echo "üìç OAC: $oac_name"
              ETAG=$(aws cloudfront get-origin-access-control --id "$oac_id" --query 'ETag' --output text 2>/dev/null)
              aws cloudfront delete-origin-access-control --id "$oac_id" --if-match "$ETAG" 2>&1 | grep -v "error" && \
              echo "   ‚úÖ Deleted" || echo "   ‚ö†Ô∏è  Still in use or could not delete"
            done
          else
            echo "‚ÑπÔ∏è  No Origin Access Controls found"
          fi

      - name: Cleanup Terraform State
        working-directory: ${{ steps.detect.outputs.dir }}
        continue-on-error: true
        run: |
          if [ -f "terraform.tfstate" ] || [ -f ".terraform/terraform.tfstate" ]; then
            echo "üßπ Cleaning local Terraform state..."
            rm -f terraform.tfstate*
            rm -f .terraform.lock.hcl
            rm -rf .terraform/
            echo "‚úÖ Local state cleaned"
          else
            echo "‚ÑπÔ∏è  No local state found"
          fi

      - name: Final Summary
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          
          echo "## ‚úÖ Destruction Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Prefix:** $PREFIX" >> $GITHUB_STEP_SUMMARY
          echo "**Completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üîç Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking for remaining resources..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CF_REMAIN=$(aws cloudfront list-distributions --output json 2>/dev/null | jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PREFIX\")) | .Id" | wc -l)
          WAF_REMAIN=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          S3_REMAIN=$(aws s3api list-buckets --output json 2>/dev/null | jq -r ".Buckets[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          RHP_REMAIN=$(aws cloudfront list-response-headers-policies --type custom --output json 2>/dev/null | jq -r ".ResponseHeadersPolicyList.Items[]? | select(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name | contains(\"$PREFIX\")) | .ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name" | wc -l)
          OAC_REMAIN=$(aws cloudfront list-origin-access-controls --output json 2>/dev/null | jq -r ".OriginAccessControlList.Items[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          
          echo "| Resource Type | Remaining |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| CloudFront Distributions | $CF_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| WAF Web ACLs | $WAF_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 Buckets | $S3_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| Response Headers Policies | $RHP_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| Origin Access Controls | $OAC_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_REMAIN=$((CF_REMAIN + WAF_REMAIN + S3_REMAIN + RHP_REMAIN + OAC_REMAIN))
          
          if [ $TOTAL_REMAIN -eq 0 ]; then
            echo "### üéâ Success!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All resources have been successfully destroyed." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è  Some Resources Remain" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some resources may still be in the process of deletion." >> $GITHUB_STEP_SUMMARY
            echo "CloudFront distributions can take 15-20 minutes to fully delete." >> $GITHUB_STEP_SUMMARY
            echo "Response Headers Policies and OACs will be deleted after their associated CloudFront distributions are gone." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You can run this workflow again to clean up any remaining resources." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can redeploy anytime using the Deploy Infrastructure workflow." >> $GITHUB_STEP_SUMMARY