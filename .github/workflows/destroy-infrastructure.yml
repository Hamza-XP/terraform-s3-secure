name: ðŸ’¥ Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'

permissions:
  contents: read

jobs:
  destroy:
    name: ðŸ’¥ Destroy All Resources
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "âŒ You must type DESTROY exactly to confirm"
            exit 1
          fi
          echo "âœ… Destruction confirmed"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Detect Terraform Directory
        id: detect
        run: |
          if [ -f "main.tf" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          elif [ -f "terraform/main.tf" ]; then
            echo "dir=terraform" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
          fi

      - name: Scan for Resources to Destroy
        id: scan
        run: |
          TF_DIR="${{ steps.detect.outputs.dir }}"
          echo "ðŸ“ Detected Terraform directory: $TF_DIR"
          if [ ! -f "$TF_DIR/terraform.tfvars" ]; then
            echo "âŒ ERROR: File not found: $TF_DIR/terraform.tfvars"
            exit 1
          fi
          PROJECT_NAME=$(grep -E '^project_name\s*=' "$TF_DIR/terraform.tfvars" | cut -d '"' -f2)
          if [ -z "$PROJECT_NAME" ]; then
            echo "âŒ ERROR: Could not extract project_name from $TF_DIR/terraform.tfvars"
            exit 1
          fi
          echo "âœ… PROJECT_NAME: $PROJECT_NAME"
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          PREFIX="${PROJECT_NAME}-${{ github.event.inputs.environment }}"
          
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
          
          echo "## ðŸ’¥ Scanning for Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Prefix:** $PREFIX" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Type | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # IMPROVED CloudFront detection - uses PROJECT_NAME for comment matching
          CF_DISTRIBUTIONS=$(aws cloudfront list-distributions --output json 2>/dev/null | jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PROJECT_NAME\")) | .Id" 2>/dev/null || true)
          CF_COUNT=$(echo "$CF_DISTRIBUTIONS" | grep -v '^$' | wc -l)
          echo "| CloudFront Distributions | $CF_COUNT | Will be disabled then deleted |" >> $GITHUB_STEP_SUMMARY
    
          # Also check by origin domain as backup
          CF_ORIGIN_COUNT=$(aws cloudfront list-distributions --output json 2>/dev/null | jq -r ".DistributionList.Items[]? | .Origins.Items[]? | select(.DomainName != null) | select(.DomainName | contains(\"$PREFIX\")) | .Id" | sort -u | wc -l)
          if [ $CF_ORIGIN_COUNT -gt 0 ]; then
            echo "| CloudFront (by origin) | $CF_ORIGIN_COUNT | Additional detection method |" >> $GITHUB_STEP_SUMMARY
          fi
          
          WAF_COUNT=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX-waf\")) | .Name" | wc -l)
          echo "| WAF Web ACLs | $WAF_COUNT | Will be deleted |" >> $GITHUB_STEP_SUMMARY
          
          S3_COUNT=$(aws s3api list-buckets --output json 2>/dev/null | jq -r ".Buckets[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          echo "| S3 Buckets | $S3_COUNT | Will be emptied and deleted |" >> $GITHUB_STEP_SUMMARY
          
          OAC_COUNT=$(aws cloudfront list-origin-access-controls --output json 2>/dev/null | jq -r ".OriginAccessControlList.Items[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          echo "| Origin Access Controls | $OAC_COUNT | Will be deleted |" >> $GITHUB_STEP_SUMMARY
          
          RHP_COUNT=$(aws cloudfront list-response-headers-policies --type custom --output json 2>/dev/null | jq -r ".ResponseHeadersPolicyList.Items[]? | select(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name | contains(\"$PREFIX\")) | .ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name" | wc -l)
          echo "| Response Headers Policies | $RHP_COUNT | Will be deleted |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "Step 1: Disable and Delete CloudFront Distributions"
        continue-on-error: true
        run: |
              PROJECT_NAME="${{ steps.scan.outputs.project_name }}"
              PREFIX="${{ steps.scan.outputs.prefix }}"
              
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "â˜ï¸  STEP 1: Disable and Delete CloudFront Distributions"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              echo "ðŸ” Using PROJECT_NAME: $PROJECT_NAME"
              echo "ðŸ” Using PREFIX: $PREFIX"
              echo ""
              
              # Get Account ID for WAF disassociation
              ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
              echo "ðŸ” AWS Account ID: $ACCOUNT_ID"
              echo ""
              
              # Initialize counters
              TOTAL_FOUND=0
              TOTAL_DISABLED=0
              TOTAL_DELETED=0
              TOTAL_FAILED=0
              FAILED_DISTRIBUTIONS=()
              
              echo "ðŸ“Š Starting CloudFront cleanup process..."
              echo "â° Start time: $(date)"
              echo ""
              
              # Use direct detection with the exact pattern from your deploy script
              echo "ðŸ” Scanning for CloudFront distributions..."
              DISTRIBUTIONS=$(aws cloudfront list-distributions --output json | \
                jq -r '.DistributionList.Items[]? | "\(.Id)|\(.Comment)|\(.Status)|\(.Enabled)|\(.WebACLId)"' || true)
              
              if [ -z "$DISTRIBUTIONS" ]; then
                echo "âœ… No CloudFront distributions found to process"
              else
                TOTAL_FOUND=$(echo "$DISTRIBUTIONS" | wc -l)
                echo "ðŸ“ Found $TOTAL_FOUND distributions to process:"
                echo ""
                
                # Process each distribution with detailed progress
                echo "$DISTRIBUTIONS" | while IFS='|' read -r dist_id comment status enabled webacl_id; do
                  # Use the same logic as your deploy script - look for PROJECT_NAME in comment
                  if [[ "$comment" == *"$PROJECT_NAME"* ]]; then
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "ðŸ”„ Processing: $dist_id"
                    echo "   Comment: $comment"
                    echo "   Status: $status"
                    echo "   Enabled: $enabled"
                    echo "   WAF Attached: $webacl_id"
                    echo ""
                    
                    # PHASE 1: DISABLE if enabled (with WAF detachment)
                    if [ "$enabled" = "true" ]; then
                      echo "   ðŸ”„ Phase 1: Disabling distribution and detaching WAF..."
                      START_TIME=$(date +%s)
                      
                      # Get current config using the improved method
                      echo "      ðŸ“¥ Fetching distribution config..."
                      CONFIG_FILE="/tmp/cf_$dist_id.json"
                      DISABLED_FILE="/tmp/cf_disabled_$dist_id.json"
                      
                      # 1ï¸âƒ£ Remove silent error suppression
                      if aws cloudfront get-distribution-config --id "$dist_id" > "$CONFIG_FILE"; then
                        ETAG=$(jq -r '.ETag' "$CONFIG_FILE")
                        echo "      âœ… Config fetched (ETag: $ETAG)"
                        
                        # 4ï¸âƒ£ Disassociate WAF cleanly before updating
                        if [ "$webacl_id" != "null" ] && [ -n "$webacl_id" ]; then
                          echo "      ðŸ›¡ï¸  Disassociating WAF..."
                          aws cloudfront disassociate-web-acl --resource-arn "arn:aws:cloudfront::${ACCOUNT_ID}:distribution/$dist_id" || true
                          echo "      âœ… WAF disassociation attempted"
                        fi
                        
                        # 2ï¸âƒ£ Add trusted signer fix and preserve all required fields
                        echo "      ðŸ“ Detaching WAF and disabling distribution with trusted signer fix..."
                        jq '.DistributionConfig
                            | .WebACLId = null
                            | .Enabled = false
                            | .DefaultCacheBehavior.TrustedSigners = (.DefaultCacheBehavior.TrustedSigners // {Enabled:false, Quantity:0})
                            | .DefaultCacheBehavior.TrustedKeyGroups = (.DefaultCacheBehavior.TrustedKeyGroups // {Enabled:false, Quantity:0})
                        ' "$CONFIG_FILE" > "$DISABLED_FILE"
                        
                        echo "      ðŸ”§ Configuration updated with trusted signer preservation"
                        
                        # 3ï¸âƒ£ Capture and print the AWS error
                        echo "      ðŸš€ Applying updated configuration..."
                        ERROR_FILE="/tmp/aws_error_$dist_id.log"
                        
                        aws cloudfront update-distribution \
                          --id "$dist_id" \
                          --if-match "$ETAG" \
                          --distribution-config file://"$DISABLED_FILE" \
                          2>&1 | tee "$ERROR_FILE"
                        
                        echo "      ðŸ” AWS CLI error (if any):"
                        cat "$ERROR_FILE"
                        
                        if [ ${PIPESTATUS[0]} -eq 0 ]; then
                          END_TIME=$(date +%s)
                          DURATION=$((END_TIME - START_TIME))
                          echo "      âœ… Disable command accepted (${DURATION}s)"
                          TOTAL_DISABLED=$((TOTAL_DISABLED + 1))
                        else
                          END_TIME=$(date +%s)
                          DURATION=$((END_TIME - START_TIME))
                          echo "      âŒ Disable command failed (${DURATION}s)"
                          FAILED_DISTRIBUTIONS+=("$dist_id:disable_failed - $(head -1 "$ERROR_FILE")")
                          TOTAL_FAILED=$((TOTAL_FAILED + 1))
                        fi
                        
                        # Clean up temp files
                        rm -f "$CONFIG_FILE" "$DISABLED_FILE" "$ERROR_FILE"
                      else
                        echo "      âŒ Failed to fetch distribution config"
                        FAILED_DISTRIBUTIONS+=("$dist_id:config_fetch_failed")
                        TOTAL_FAILED=$((TOTAL_FAILED + 1))
                      fi
                    else
                      echo "   âœ… Already disabled - checking WAF attachment..."
                      
                      # Even if disabled, we should detach WAF if present
                      if [ "$webacl_id" != "null" ] && [ -n "$webacl_id" ]; then
                        echo "   ðŸ”„ Detaching WAF from disabled distribution..."
                        START_TIME=$(date +%s)
                        
                        # Disassociate WAF cleanly
                        echo "      ðŸ›¡ï¸  Disassociating WAF from disabled distribution..."
                        aws cloudfront disassociate-web-acl --resource-arn "arn:aws:cloudfront::${ACCOUNT_ID}:distribution/$dist_id" || true
                        
                        END_TIME=$(date +%s)
                        DURATION=$((END_TIME - START_TIME))
                        echo "      âœ… WAF disassociation attempted (${DURATION}s)"
                      else
                        echo "   âœ… No WAF attached to disabled distribution"
                      fi
                    fi
                    
                    # PHASE 2: DELETE distribution
                    echo ""
                    echo "   ðŸ—‘ï¸  Phase 2: Deleting distribution..."
                    START_TIME=$(date +%s)
                    
                    echo "      ðŸ“¥ Getting current ETag for deletion..."
                    ETAG=$(aws cloudfront get-distribution --id "$dist_id" --query 'ETag' --output text)
                    
                    if [ -n "$ETAG" ]; then
                      echo "      âœ… ETag obtained: $ETAG"
                      echo "      ðŸš€ Initiating deletion..."
                      
                      # Remove silent error suppression for deletion too
                      DELETE_ERROR_FILE="/tmp/aws_delete_error_$dist_id.log"
                      if aws cloudfront delete-distribution --id "$dist_id" --if-match "$ETAG" 2>&1 | tee "$DELETE_ERROR_FILE"; then
                        END_TIME=$(date +%s)
                        DURATION=$((END_TIME - START_TIME))
                        echo "      âœ… Deletion initiated successfully (${DURATION}s)"
                        TOTAL_DELETED=$((TOTAL_DELETED + 1))
                      else
                        END_TIME=$(date +%s)
                        DURATION=$((END_TIME - START_TIME))
                        
                        # Check why deletion failed
                        CURRENT_STATUS=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.Status' --output text || echo "Unknown")
                        CURRENT_ENABLED=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.DistributionConfig.Enabled' --output text || echo "Unknown")
                        
                        echo "      âš ï¸  Immediate deletion failed (${DURATION}s)"
                        echo "      ðŸ” AWS CLI error:"
                        cat "$DELETE_ERROR_FILE"
                        echo "      ðŸ“Š Current state - Status: $CURRENT_STATUS, Enabled: $CURRENT_ENABLED"
                        echo "      ðŸ’¡ This is normal - distribution will be retried in Step 9"
                        
                        # Only count as failure if it's still enabled and can't be deleted
                        if [ "$CURRENT_ENABLED" = "true" ]; then
                          FAILED_DISTRIBUTIONS+=("$dist_id:still_enabled")
                          TOTAL_FAILED=$((TOTAL_FAILED + 1))
                        fi
                      fi
                      rm -f "$DELETE_ERROR_FILE"
                    else
                      echo "      âŒ Could not get ETag for distribution"
                      FAILED_DISTRIBUTIONS+=("$dist_id:etag_failed")
                      TOTAL_FAILED=$((TOTAL_FAILED + 1))
                    fi
                    
                    echo "   âœ… Processing completed for $dist_id"
                    echo ""
                    
                  else
                    echo "â­ï¸  Skipping: $dist_id (comment doesn't match: $comment)"
                  fi
                done
                
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ðŸ“Š STEP 1 COMPLETION SUMMARY"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "â° End time: $(date)"
                echo ""
                echo "ðŸ“ˆ Progress Metrics:"
                echo "   ðŸ“‹ Total Found:    $TOTAL_FOUND"
                echo "   ðŸ”„ Total Disabled: $TOTAL_DISABLED"
                echo "   ðŸ—‘ï¸  Total Deleted:  $TOTAL_DELETED"
                echo "   âŒ Total Failed:    $TOTAL_FAILED"
                echo ""
                
                if [ $TOTAL_FAILED -gt 0 ]; then
                  echo "âš ï¸  Failed Distributions:"
                  for failed in "${FAILED_DISTRIBUTIONS[@]}"; do
                    echo "   - $failed"
                  done
                  echo ""
                  echo "ðŸ’¡ Failed distributions will be retried in Step 9"
                fi
                
                if [ $TOTAL_DELETED -eq $TOTAL_FOUND ]; then
                  echo "ðŸŽ‰ SUCCESS: All distributions processed successfully!"
                elif [ $TOTAL_DELETED -gt 0 ]; then
                  echo "âœ… PARTIAL SUCCESS: Some distributions processed, others will be retried"
                else
                  echo "âŒ NO DISTRIBUTIONS: Could not process any distributions"
                fi
              fi
              
              echo ""
              echo "â³ Waiting 60 seconds for operations to propagate..."
              sleep 60
              echo "âœ… Step 1 completed - proceeding to next steps"

      - name: "Step 2: Empty and Delete S3 Buckets"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ STEP 2: Emptying and Deleting S3 Buckets"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          BUCKETS=$(aws s3api list-buckets --output json 2>/dev/null | \
            jq -r ".Buckets[]? | select(.Name | contains(\"$PREFIX\")) | .Name" 2>/dev/null || true)
          
          if [ -z "$BUCKETS" ]; then
            echo "â„¹ï¸  No S3 buckets found with prefix: $PREFIX"
          else
            echo "$BUCKETS" | while read -r bucket; do
              echo "ðŸ“ Bucket: $bucket"
              echo "   Emptying all objects and versions..."
              
              # Delete all object versions
              aws s3api list-object-versions --bucket "$bucket" --output json 2>/dev/null | \
                jq -r '.Versions[]?, .DeleteMarkers[]? | "\(.Key)\t\(.VersionId)"' | \
                while IFS=$'\t' read -r key version; do
                  if [ -n "$key" ]; then
                    aws s3api delete-object --bucket "$bucket" --key "$key" --version-id "$version" 2>/dev/null || true
                  fi
                done
              
              # Delete all objects (non-versioned)
              aws s3 rm "s3://$bucket" --recursive --quiet 2>/dev/null || true
              
              echo "   Deleting bucket..."
              aws s3 rb "s3://$bucket" --force 2>&1 | grep -v "BucketNotEmpty\|NoSuchBucket" && \
              echo "   âœ… Deleted" || echo "   âš ï¸  Could not delete (may still have objects)"
            done
          fi

      - name: "Step 3: Delete WAF Web ACLs"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ›¡ï¸  STEP 3: Deleting WAF Web ACLs"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          WAFS=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | \
            jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | \"\(.Id)|\(.Name)|\(.LockToken)\"" 2>/dev/null || true)
          
          if [ -z "$WAFS" ]; then
            echo "â„¹ï¸  No WAF Web ACLs found with prefix: $PREFIX"
          else
            echo "$WAFS" | while IFS='|' read -r waf_id waf_name lock_token; do
              echo "ðŸ“ WAF: $waf_name"
              
              ATTACHED=$(aws cloudfront list-distributions --output json 2>/dev/null | \
                        jq -r ".DistributionList.Items[]? | select(.WebACLId | contains(\"$waf_id\")) | .Id" | head -1)
              
              if [ -n "$ATTACHED" ]; then
                echo "   â³ Still attached to CloudFront $ATTACHED, will retry later"
              else
                echo "   Deleting..."
                aws wafv2 delete-web-acl \
                  --name "$waf_name" \
                  --scope CLOUDFRONT \
                  --id "$waf_id" \
                  --lock-token "$lock_token" \
                  --region us-east-1 2>&1 | grep -v "error" && \
                echo "   âœ… Deleted" || echo "   âš ï¸  Could not delete"
              fi
            done
          fi

      - name: "Wait for CloudFront Distributions"
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â³ WAITING: CloudFront Distributions to Fully Disable"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "This may take 10-15 minutes. Checking every 60 seconds..."
          echo ""
          
          MAX_WAIT=900
          ELAPSED=0
          FOUND_DISTRIBUTIONS=false
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            DIST_IDS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
                      jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PREFIX\")) | .Id" 2>/dev/null || true)
            
            if [ -z "$DIST_IDS" ]; then
              if [ "$FOUND_DISTRIBUTIONS" = "false" ] && [ $ELAPSED -eq 0 ]; then
                echo "â„¹ï¸  No distributions found with prefix: $PREFIX"
              else
                echo "âœ… All distributions have been deleted"
              fi
              break
            fi
            
            FOUND_DISTRIBUTIONS=true
            ALL_DISABLED=true
            
            for dist_id in $DIST_IDS; do
              STATUS=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.Status' --output text 2>/dev/null || echo "Unknown")
              ENABLED=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.DistributionConfig.Enabled' --output text 2>/dev/null || echo "Unknown")
              
              echo "   $dist_id: Status=$STATUS, Enabled=$ENABLED"
              
              if [ "$ENABLED" = "True" ] || [ "$STATUS" = "InProgress" ]; then
                ALL_DISABLED=false
              fi
            done
            
            if [ "$ALL_DISABLED" = "true" ]; then
              echo ""
              echo "âœ… All distributions are disabled and deployed"
              break
            fi
            
            sleep 60
            ELAPSED=$((ELAPSED + 60))
            echo "   Waited ${ELAPSED}s / ${MAX_WAIT}s..."
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âš ï¸  Maximum wait time reached. Some distributions may still be deploying."
          fi

      - name: "Step 9: Delete CloudFront Distributions"
        continue-on-error: true
        run: |
            PROJECT_NAME="${{ steps.scan.outputs.project_name }}"
            PREFIX="${{ steps.scan.outputs.prefix }}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â˜ï¸  STEP 9: Deleting CloudFront Distributions"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ðŸ” Using PROJECT_NAME: $PROJECT_NAME for detection"
            
            # Use the SAME detection logic as Step 1 and scan - by PROJECT_NAME in comment
            DISTRIBUTIONS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
              jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PROJECT_NAME\")) | \"\(.Id)|\(.Comment)|\(.Status)\"" 2>/dev/null || true)
            
            if [ -z "$DISTRIBUTIONS" ]; then
              echo "âŒ No distributions found by comment. Trying origin domain detection..."
              # Fallback: detect by origin domain
              DISTRIBUTIONS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
                jq -r ".DistributionList.Items[]? | .Id as \$id | .Comment as \$comment | .Origins.Items[]? | select(.DomainName != null) | select(.DomainName | contains(\"$PREFIX\")) | \"\$id|\$comment|unknown\"" 2>/dev/null || true)
            fi
            
            if [ -z "$DISTRIBUTIONS" ]; then
              echo "âŒ No CloudFront distributions found for deletion."
              echo "ðŸ’¡ Manual deletion may be required for: E191G2X7VOQUCR, E39ARSICL9MJ2Q, E2D8L23FW0GDEQ, E35EJ3YWAN0M0S, E2T09YD9M9AYYO"
            else
              echo "ðŸ“ Found distributions for deletion:"
              echo "$DISTRIBUTIONS" | while IFS='|' read -r dist_id comment status; do
                echo "   ðŸ”¸ $dist_id - $comment (Status: $status)"
              done
              echo ""
              
              echo "ðŸ—‘ï¸  Deleting CloudFront distributions..."
              echo "$DISTRIBUTIONS" | while IFS='|' read -r dist_id comment status; do
                echo "ðŸ“ Deleting: $dist_id ($comment)"
                
                # Get the ETag and delete
                ETAG=$(aws cloudfront get-distribution --id "$dist_id" --query 'ETag' --output text 2>/dev/null)
                if [ -n "$ETAG" ]; then
                  # Attempt deletion
                  if aws cloudfront delete-distribution --id "$dist_id" --if-match "$ETAG" 2>/dev/null; then
                    echo "   âœ… Deletion initiated successfully"
                  else
                    # Check if it's still deploying
                    CURRENT_STATUS=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.Status' --output text 2>/dev/null || echo "Unknown")
                    if [ "$CURRENT_STATUS" = "InProgress" ]; then
                      echo "   â³ Still deploying, will be deleted on next run"
                    else
                      echo "   âŒ Failed to delete (Status: $CURRENT_STATUS)"
                    fi
                  fi
                else
                  echo "   âŒ Could not get ETag for distribution"
                fi
              done
              
              echo ""
              echo "ðŸ“ Note: CloudFront deletions can take 15-20 minutes to complete."
              echo "   The distributions will disappear from the console when fully deleted."
            fi

      - name: "Verify CloudFront Deletion"
        continue-on-error: true
        run: |
            PROJECT_NAME="${{ steps.scan.outputs.project_name }}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… VERIFY: CloudFront Deletion Status"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            # Check remaining distributions
            REMAINING_DISTRIBUTIONS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
              jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PROJECT_NAME\")) | \"\(.Id)|\(.Comment)|\(.Status)\"" 2>/dev/null || true)
            
            if [ -z "$REMAINING_DISTRIBUTIONS" ]; then
              echo "ðŸŽ‰ SUCCESS: All CloudFront distributions have been deleted!"
            else
              echo "âš ï¸  Some distributions are still present:"
              echo "$REMAINING_DISTRIBUTIONS" | while IFS='|' read -r dist_id comment status; do
                echo "   ðŸ”¸ $dist_id - $comment (Status: $status)"
              done
              echo ""
              echo "ðŸ’¡ CloudFront deletions can take 15-20 minutes. Run this workflow again if needed."
            fi

      - name: "Step 10: Retry WAF Deletion"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ›¡ï¸  STEP 10: Retrying WAF Deletion (After CloudFront)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          WAFS=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | \
            jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | \"\(.Id)|\(.Name)|\(.LockToken)\"" 2>/dev/null || true)
          
          if [ -z "$WAFS" ]; then
            echo "â„¹ï¸  No WAF Web ACLs found with prefix: $PREFIX"
          else
            echo "$WAFS" | while IFS='|' read -r waf_id waf_name lock_token; do
              echo "ðŸ“ WAF: $waf_name"
              aws wafv2 delete-web-acl \
                --name "$waf_name" \
                --scope CLOUDFRONT \
                --id "$waf_id" \
                --lock-token "$lock_token" \
                --region us-east-1 2>&1 | grep -v "error" && \
              echo "   âœ… Deleted" || echo "   âš ï¸  Could not delete"
            done
          fi

      - name: "Step 11: Retry Response Headers Policies and OAC"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”„ STEP 11: Retrying Policies and OAC Deletion"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Retry Response Headers Policies
          echo "ðŸ“‹ Response Headers Policies:"
          RHP=$(aws cloudfront list-response-headers-policies --type custom --output json 2>/dev/null | \
            jq -r ".ResponseHeadersPolicyList.Items[]? | select(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name | contains(\"$PREFIX\")) | \"\(.ResponseHeadersPolicy.Id)|\(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name)\"" 2>/dev/null || true)
          
          if [ -n "$RHP" ]; then
            echo "$RHP" | while IFS='|' read -r policy_id policy_name; do
              echo "ðŸ“ Policy: $policy_name"
              ETAG=$(aws cloudfront get-response-headers-policy --id "$policy_id" --query 'ETag' --output text 2>/dev/null)
              aws cloudfront delete-response-headers-policy --id "$policy_id" --if-match "$ETAG" 2>&1 | grep -v "error" && \
              echo "   âœ… Deleted" || echo "   âš ï¸  Still in use or could not delete"
            done
          else
            echo "â„¹ï¸  No Response Headers Policies found"
          fi
          
          echo ""
          
          # Retry Origin Access Controls
          echo "ðŸ”’ Origin Access Controls:"
          OAC=$(aws cloudfront list-origin-access-controls --output json 2>/dev/null | \
            jq -r ".OriginAccessControlList.Items[]? | select(.Name | contains(\"$PREFIX\")) | \"\(.Id)|\(.Name)\"" 2>/dev/null || true)
          
          if [ -n "$OAC" ]; then
            echo "$OAC" | while IFS='|' read -r oac_id oac_name; do
              echo "ðŸ“ OAC: $oac_name"
              ETAG=$(aws cloudfront get-origin-access-control --id "$oac_id" --query 'ETag' --output text 2>/dev/null)
              aws cloudfront delete-origin-access-control --id "$oac_id" --if-match "$ETAG" 2>&1 | grep -v "error" && \
              echo "   âœ… Deleted" || echo "   âš ï¸  Still in use or could not delete"
            done
          else
            echo "â„¹ï¸  No Origin Access Controls found"
          fi

      - name: Cleanup Terraform State
        working-directory: ${{ steps.detect.outputs.dir }}
        continue-on-error: true
        run: |
          if [ -f "terraform.tfstate" ] || [ -f ".terraform/terraform.tfstate" ]; then
            echo "ðŸ§¹ Cleaning local Terraform state..."
            rm -f terraform.tfstate*
            rm -f .terraform.lock.hcl
            rm -rf .terraform/
            echo "âœ… Local state cleaned"
          else
            echo "â„¹ï¸  No local state found"
          fi

      - name: Final Summary
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          
          echo "## âœ… Destruction Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Prefix:** $PREFIX" >> $GITHUB_STEP_SUMMARY
          echo "**Completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking for remaining resources..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CF_REMAIN=$(aws cloudfront list-distributions --output json 2>/dev/null | jq -r ".DistributionList.Items[]? | select(.Comment != null) | select(.Comment | contains(\"$PREFIX\")) | .Id" | wc -l)
          WAF_REMAIN=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          S3_REMAIN=$(aws s3api list-buckets --output json 2>/dev/null | jq -r ".Buckets[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          RHP_REMAIN=$(aws cloudfront list-response-headers-policies --type custom --output json 2>/dev/null | jq -r ".ResponseHeadersPolicyList.Items[]? | select(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name | contains(\"$PREFIX\")) | .ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name" | wc -l)
          OAC_REMAIN=$(aws cloudfront list-origin-access-controls --output json 2>/dev/null | jq -r ".OriginAccessControlList.Items[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          
          echo "| Resource Type | Remaining |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| CloudFront Distributions | $CF_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| WAF Web ACLs | $WAF_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 Buckets | $S3_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| Response Headers Policies | $RHP_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| Origin Access Controls | $OAC_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_REMAIN=$((CF_REMAIN + WAF_REMAIN + S3_REMAIN + RHP_REMAIN + OAC_REMAIN))
          
          if [ $TOTAL_REMAIN -eq 0 ]; then
            echo "### ðŸŽ‰ Success!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All resources have been successfully destroyed." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸  Some Resources Remain" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some resources may still be in the process of deletion." >> $GITHUB_STEP_SUMMARY
            echo "CloudFront distributions can take 15-20 minutes to fully delete." >> $GITHUB_STEP_SUMMARY
            echo "Response Headers Policies and OACs will be deleted after their associated CloudFront distributions are gone." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You can run this workflow again to clean up any remaining resources." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can redeploy anytime using the Deploy Infrastructure workflow." >> $GITHUB_STEP_SUMMARY