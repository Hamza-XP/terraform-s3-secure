name: 💥 Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'

permissions:
  contents: read

jobs:
  destroy:
    name: 💥 Destroy All Resources
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "❌ You must type DESTROY exactly to confirm"
            exit 1
          fi
          echo "✅ Destruction confirmed"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Detect Terraform Directory
        id: detect
        run: |
          if [ -f "main.tf" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          elif [ -f "terraform/main.tf" ]; then
            echo "dir=terraform" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
          fi

      - name: Scan for Resources to Destroy
        id: scan
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            PREFIX="secure-website-production"
          else
            PREFIX="secure-website-staging"
          fi
          
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
          
          echo "## 💥 Scanning for Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Prefix:** $PREFIX" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Type | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          CF_COUNT=$(aws cloudfront list-distributions --output json 2>/dev/null | jq -r ".DistributionList.Items[]? | select(.Comment | contains(\"$PREFIX\")) | .Id" | wc -l)
          echo "| CloudFront Distributions | $CF_COUNT | Will be disabled then deleted |" >> $GITHUB_STEP_SUMMARY
          
          WAF_COUNT=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          echo "| WAF Web ACLs | $WAF_COUNT | Will be deleted |" >> $GITHUB_STEP_SUMMARY
          
          S3_COUNT=$(aws s3api list-buckets --output json 2>/dev/null | jq -r ".Buckets[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          echo "| S3 Buckets | $S3_COUNT | Will be emptied and deleted |" >> $GITHUB_STEP_SUMMARY
          
          OAC_COUNT=$(aws cloudfront list-origin-access-controls --output json 2>/dev/null | jq -r ".OriginAccessControlList.Items[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          echo "| Origin Access Controls | $OAC_COUNT | Will be deleted |" >> $GITHUB_STEP_SUMMARY
          
          RHP_COUNT=$(aws cloudfront list-response-headers-policies --type custom --output json 2>/dev/null | jq -r ".ResponseHeadersPolicyList.Items[]? | select(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name | contains(\"$PREFIX\")) | .ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name" | wc -l)
          echo "| Response Headers Policies | $RHP_COUNT | Will be deleted |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "Step 1: Disable CloudFront Distributions"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "☁️  STEP 1: Disabling CloudFront Distributions"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          aws cloudfront list-distributions --output json 2>/dev/null | \
          jq -r ".DistributionList.Items[]? | select(.Comment | contains(\"$PREFIX\")) | \"\(.Id)|\(.Comment)|\(.Enabled)\"" | \
          while IFS='|' read -r dist_id comment enabled; do
            echo "📍 Distribution: $dist_id ($comment)"
            
            if [ "$enabled" = "true" ]; then
              echo "   Disabling..."
              aws cloudfront get-distribution-config --id "$dist_id" > /tmp/cf_$dist_id.json 2>/dev/null
              ETAG=$(jq -r '.ETag' /tmp/cf_$dist_id.json)
              jq '.DistributionConfig.Enabled = false' /tmp/cf_$dist_id.json > /tmp/cf_disabled_$dist_id.json
              
              aws cloudfront update-distribution \
                --id "$dist_id" \
                --if-match "$ETAG" \
                --distribution-config "$(jq -c '.DistributionConfig' /tmp/cf_disabled_$dist_id.json)" \
                2>/dev/null && echo "   ✅ Disabled" || echo "   ⚠️  Already disabled"
            else
              echo "   ✅ Already disabled"
            fi
          done
          
          echo ""
          echo "⏳ Waiting 30 seconds for distributions to start disabling..."
          sleep 30

      - name: "Step 2: Empty and Delete S3 Buckets"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📦 STEP 2: Emptying and Deleting S3 Buckets"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          aws s3api list-buckets --output json 2>/dev/null | \
          jq -r ".Buckets[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | \
          while read -r bucket; do
            echo "📍 Bucket: $bucket"
            echo "   Emptying all objects and versions..."
            
            aws s3api list-object-versions --bucket "$bucket" --output json 2>/dev/null | \
            jq -r '.Versions[]?, .DeleteMarkers[]? | "\(.Key)\t\(.VersionId)"' | \
            while IFS=$'\t' read -r key version; do
              aws s3api delete-object --bucket "$bucket" --key "$key" --version-id "$version" 2>/dev/null
            done
            
            aws s3 rm "s3://$bucket" --recursive --quiet 2>/dev/null || true
            
            echo "   Deleting bucket..."
            aws s3 rb "s3://$bucket" --force 2>&1 && \
            echo "   ✅ Deleted" || echo "   ⚠️  Could not delete"
          done

      - name: "Step 3: Delete WAF Web ACLs"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🛡️  STEP 3: Deleting WAF Web ACLs"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | \
          jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | \"\(.Id)|\(.Name)|\(.LockToken)\"" | \
          while IFS='|' read -r waf_id waf_name lock_token; do
            echo "📍 WAF: $waf_name"
            
            ATTACHED=$(aws cloudfront list-distributions --output json 2>/dev/null | \
                      jq -r ".DistributionList.Items[]? | select(.WebACLId | contains(\"$waf_id\")) | .Id" | head -1)
            
            if [ -n "$ATTACHED" ]; then
              echo "   ⏳ Still attached to CloudFront $ATTACHED, will retry later"
            else
              echo "   Deleting..."
              aws wafv2 delete-web-acl \
                --scope CLOUDFRONT \
                --id "$waf_id" \
                --lock-token "$lock_token" \
                --region us-east-1 2>&1 && \
              echo "   ✅ Deleted" || echo "   ⚠️  Could not delete"
            fi
          done

      - name: "Step 4: Delete CloudWatch Resources"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 STEP 4: Deleting CloudWatch Resources"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          echo "📊 Dashboards:"
          aws cloudwatch list-dashboards --region us-east-1 --output json 2>/dev/null | \
          jq -r ".DashboardEntries[]? | select(.DashboardName | contains(\"$PREFIX\")) | .DashboardName" | \
          while read -r dashboard; do
            echo "   📍 $dashboard"
            aws cloudwatch delete-dashboards --dashboard-names "$dashboard" --region us-east-1 2>&1 && \
            echo "      ✅ Deleted" || echo "      ⚠️  Could not delete"
          done
          
          echo ""
          echo "📝 Log Groups:"
          aws logs describe-log-groups --output json 2>/dev/null | \
          jq -r ".logGroups[]? | select(.logGroupName | contains(\"$PREFIX\")) | .logGroupName" | \
          while read -r log_group; do
            echo "   📍 $log_group"
            aws logs delete-log-group --log-group-name "$log_group" 2>&1 && \
            echo "      ✅ Deleted" || echo "      ⚠️  Could not delete"
          done

      - name: "Step 5: Delete Kinesis Firehose Streams"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🔥 STEP 5: Deleting Kinesis Firehose Streams"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          aws firehose list-delivery-streams --output json 2>/dev/null | \
          jq -r ".DeliveryStreamNames[]?" | grep "$PREFIX" | \
          while read -r stream; do
            echo "📍 Stream: $stream"
            aws firehose delete-delivery-stream --delivery-stream-name "$stream" 2>&1 && \
            echo "   ✅ Deleted" || echo "   ⚠️  Could not delete"
          done

      - name: "Step 6: Delete IAM Roles"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "👤 STEP 6: Deleting IAM Roles"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          aws iam list-roles --output json 2>/dev/null | \
          jq -r ".Roles[]? | select(.RoleName | contains(\"$PREFIX\")) | .RoleName" | \
          while read -r role; do
            echo "📍 Role: $role"
            
            aws iam list-role-policies --role-name "$role" --output json 2>/dev/null | \
            jq -r '.PolicyNames[]?' | \
            while read -r policy; do
              aws iam delete-role-policy --role-name "$role" --policy-name "$policy" 2>/dev/null
            done
            
            aws iam list-attached-role-policies --role-name "$role" --output json 2>/dev/null | \
            jq -r '.AttachedPolicies[]?.PolicyArn' | \
            while read -r policy_arn; do
              aws iam detach-role-policy --role-name "$role" --policy-arn "$policy_arn" 2>/dev/null
            done
            
            aws iam delete-role --role-name "$role" 2>&1 && \
            echo "   ✅ Deleted" || echo "   ⚠️  Could not delete"
          done

      - name: "Step 7: Delete Response Headers Policies"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📋 STEP 7: Deleting Response Headers Policies"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          aws cloudfront list-response-headers-policies --type custom --output json 2>/dev/null | \
          jq -r ".ResponseHeadersPolicyList.Items[]? | select(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name | contains(\"$PREFIX\")) | \"\(.ResponseHeadersPolicy.Id)|\(.ResponseHeadersPolicy.ResponseHeadersPolicyConfig.Name)\"" | \
          while IFS='|' read -r policy_id policy_name; do
            echo "📍 Policy: $policy_name"
            ETAG=$(aws cloudfront get-response-headers-policy --id "$policy_id" --query 'ETag' --output text 2>/dev/null)
            aws cloudfront delete-response-headers-policy --id "$policy_id" --if-match "$ETAG" 2>&1 && \
            echo "   ✅ Deleted" || echo "   ⚠️  Could not delete"
          done

      - name: "Step 8: Delete Origin Access Controls"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🔒 STEP 8: Deleting Origin Access Controls"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          aws cloudfront list-origin-access-controls --output json 2>/dev/null | \
          jq -r ".OriginAccessControlList.Items[]? | select(.Name | contains(\"$PREFIX\")) | \"\(.Id)|\(.Name)\"" | \
          while IFS='|' read -r oac_id oac_name; do
            echo "📍 OAC: $oac_name"
            ETAG=$(aws cloudfront get-origin-access-control --id "$oac_id" --query 'ETag' --output text 2>/dev/null)
            aws cloudfront delete-origin-access-control --id "$oac_id" --if-match "$ETAG" 2>&1 && \
            echo "   ✅ Deleted" || echo "   ⚠️  Could not delete"
          done

      - name: "Wait for CloudFront Distributions"
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "⏳ WAITING: CloudFront Distributions to Fully Disable"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "This may take 10-15 minutes. Checking every 60 seconds..."
          echo ""
          
          MAX_WAIT=900
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            DIST_IDS=$(aws cloudfront list-distributions --output json 2>/dev/null | \
                      jq -r ".DistributionList.Items[]? | select(.Comment | contains(\"$PREFIX\")) | .Id")
            
            if [ -z "$DIST_IDS" ]; then
              echo "✅ No distributions found"
              break
            fi
            
            ALL_DISABLED=true
            for dist_id in $DIST_IDS; do
              STATUS=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.Status' --output text 2>/dev/null)
              ENABLED=$(aws cloudfront get-distribution --id "$dist_id" --query 'Distribution.DistributionConfig.Enabled' --output text 2>/dev/null)
              
              echo "   $dist_id: Status=$STATUS, Enabled=$ENABLED"
              
              if [ "$ENABLED" = "True" ] || [ "$STATUS" = "InProgress" ]; then
                ALL_DISABLED=false
              fi
            done
            
            if [ "$ALL_DISABLED" = "true" ]; then
              echo ""
              echo "✅ All distributions are disabled and deployed"
              break
            fi
            
            sleep 60
            ELAPSED=$((ELAPSED + 60))
            echo "   Waited ${ELAPSED}s / ${MAX_WAIT}s..."
          done

      - name: "Step 9: Delete CloudFront Distributions"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "☁️  STEP 9: Deleting CloudFront Distributions"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          aws cloudfront list-distributions --output json 2>/dev/null | \
          jq -r ".DistributionList.Items[]? | select(.Comment | contains(\"$PREFIX\")) | \"\(.Id)|\(.Comment)\"" | \
          while IFS='|' read -r dist_id comment; do
            echo "📍 Distribution: $dist_id ($comment)"
            ETAG=$(aws cloudfront get-distribution --id "$dist_id" --query 'ETag' --output text 2>/dev/null)
            aws cloudfront delete-distribution --id "$dist_id" --if-match "$ETAG" 2>&1 && \
            echo "   ✅ Deleted" || echo "   ⚠️  Could not delete (may still be deploying)"
          done

      - name: "Step 10: Retry WAF Deletion"
        continue-on-error: true
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🛡️  STEP 10: Retrying WAF Deletion (After CloudFront)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | \
          jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | \"\(.Id)|\(.Name)|\(.LockToken)\"" | \
          while IFS='|' read -r waf_id waf_name lock_token; do
            echo "📍 WAF: $waf_name"
            aws wafv2 delete-web-acl \
              --scope CLOUDFRONT \
              --id "$waf_id" \
              --lock-token "$lock_token" \
              --region us-east-1 2>&1 && \
            echo "   ✅ Deleted" || echo "   ⚠️  Could not delete"
          done

      - name: Cleanup Terraform State
        working-directory: ${{ steps.detect.outputs.dir }}
        continue-on-error: true
        run: |
          if [ -f "terraform.tfstate" ] || [ -f ".terraform/terraform.tfstate" ]; then
            echo "🧹 Cleaning local Terraform state..."
            rm -f terraform.tfstate*
            rm -f .terraform.lock.hcl
            rm -rf .terraform/
            echo "✅ Local state cleaned"
          else
            echo "ℹ️  No local state found"
          fi

      - name: Final Summary
        run: |
          PREFIX="${{ steps.scan.outputs.prefix }}"
          
          echo "## ✅ Destruction Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Prefix:** $PREFIX" >> $GITHUB_STEP_SUMMARY
          echo "**Completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 🔍 Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking for remaining resources..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CF_REMAIN=$(aws cloudfront list-distributions --output json 2>/dev/null | jq -r ".DistributionList.Items[]? | select(.Comment | contains(\"$PREFIX\")) | .Id" | wc -l)
          WAF_REMAIN=$(aws wafv2 list-web-acls --scope CLOUDFRONT --region us-east-1 --output json 2>/dev/null | jq -r ".WebACLs[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          S3_REMAIN=$(aws s3api list-buckets --output json 2>/dev/null | jq -r ".Buckets[]? | select(.Name | contains(\"$PREFIX\")) | .Name" | wc -l)
          
          echo "| Resource Type | Remaining |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| CloudFront Distributions | $CF_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| WAF Web ACLs | $WAF_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 Buckets | $S3_REMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $CF_REMAIN -eq 0 ] && [ $WAF_REMAIN -eq 0 ] && [ $S3_REMAIN -eq 0 ]; then
            echo "### 🎉 Success!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All resources have been successfully destroyed." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ⚠️  Some Resources Remain" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some resources may still be in the process of deletion." >> $GITHUB_STEP_SUMMARY
            echo "CloudFront distributions can take 15-20 minutes to fully delete." >> $GITHUB_STEP_SUMMARY
            echo "You can run this workflow again to clean up any remaining resources." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can redeploy anytime using the Deploy Infrastructure workflow." >> $GITHUB_STEP_SUMMARY